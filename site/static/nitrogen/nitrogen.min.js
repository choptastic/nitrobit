function NitrogenClass(a){this.$url=document.location.href;this.$div=document;this.$anchor_root_path=document;this.$params=new Object();this.$event_queue=new Array();this.$event_is_running=false;this.$event_success_fun=null;this.$event_error_fun=null;this.$system_event_queue=new Array();this.$system_event_is_running=false;this.$system_event_obj=null;this.$going_away=false;this.$live_validation_data_field="LV_live_validation";this.$before_postback_list=new Array();this.$js_dependencies=new Array();this.$websocket=null;this.$websockets_enabled=false;return this}NitrogenClass.prototype.$path_alias=function(a){if(a==="page"){return document}else{return a}};NitrogenClass.prototype.$anchor=function(a,b){this.$anchor_path=this.$path_alias(a);this.$target_path=this.$path_alias(b)};NitrogenClass.prototype.$anchor_root=function(a){this.$anchor_root_path=a};NitrogenClass.prototype.$set_param=function(a,b){this.$params[a]=b};NitrogenClass.prototype.$destroy=function(){document.comet_started=false;this.$going_away=true;this.$system_event_queue=new Array();if(this.$system_event_obj!==null){this.$system_event_obj.abort()}if(this.$websocket){this.$websocket.disconnect()}this.$system_event_is_running=false};NitrogenClass.prototype.$queue_event=function(b,e,c,a,d){this.$event_queue.push({validationGroup:b,onInvalid:e,eventContext:c,extraParam:a,ajaxSettings:d})};NitrogenClass.prototype.$queue_system_event=function(a){this.$system_event_queue.push({eventContext:a})};NitrogenClass.prototype.$event_loop=function(){var a=this;if(!this.$system_event_is_running&&this.$system_event_queue.length>0){var b=this.$system_event_queue.shift();this.$do_system_event(b.eventContext)}if(!this.$event_is_running&&this.$event_queue.length>0){var b=this.$event_queue.shift();this.$do_event(b.validationGroup,b.onInvalid,b.eventContext,b.extraParam,b.ajaxSettings)}if(this.$system_event_queue.length==0||this.$event_queue.length==0){if(this.$going_away){return}else{setTimeout(function(){a.$event_loop()},50);return}}if(this.$event_is_running||this.$system_event_is_running){setTimeout(function(){a.$event_loop()},10);return}setTimeout(function(){a.$event_loop()},1)};NitrogenClass.prototype.$before_postback=function(a){this.$before_postback_list.push(a)};NitrogenClass.prototype.$execute_before_postbacks=function(){var c=this.$before_postback_list;for(var b=0;b<c.length;b++){try{c[b]()}catch(a){Nitrogen.$console_log({before_postback_error:a})}}};NitrogenClass.prototype.$validate_and_serialize=function(b){var a=true,c={},d=this;this.$execute_before_postbacks();jQuery(":input").not(".no_postback").each(function(e){var f=Nitrogen.$get_validation(this);if(f&&f.group==b&&!f.validate()){a=false}else{if((this.type=="radio"||this.type=="checkbox")&&!this.checked){return}c[d.$make_id(this)]=$(this).val()}});return a&&c||null};NitrogenClass.prototype.$add_validation=function(b,a){if($(b)){if(!$(b).data(Nitrogen.$live_validation_data_field)){$(b).data(Nitrogen.$live_validation_data_field,new LiveValidation(b,a))}return Nitrogen.$get_validation(b)}else{return null}};NitrogenClass.prototype.$get_validation=function(a){return $(a).data(Nitrogen.$live_validation_data_field)};NitrogenClass.prototype.$destroy_specific_validation=function(b,c){var a=NitrogenClass.$get_validation(c);if(a.group==b){Nitrogen.$destroy_target_validation(element)}};NitrogenClass.prototype.$destroy_target_validation=function(b){var a=Nitrogen.$get_validation(b);if(a){a.destroy();$(b).data(Nitrogen.$live_validation_data_field,null)}};NitrogenClass.prototype.$destroy_validation_group=function(a){jQuery(":input").not(".no_postback").each(function(b){var c=Nitrogen.$get_validation(this);if(c&&c.group==a){Nitrogen.$destroy_target_validation(this)}})};NitrogenClass.prototype.$destroy_all_validation=function(){$("*").each(function(){Nitrogen.$destroy_target_validation(this)})};NitrogenClass.prototype.$make_id=function(c){var b=[];var d=new RegExp(".wfid_(.[^\\s]*)","g");while(c&&c.className){var e=c.className.match(/wfid_([^\s])+/g);if(e){b.unshift.apply(b,e)}c=c.parentNode}return b.join(".")};NitrogenClass.prototype.$do_event=function(d,h,f,b,i){var a=this;this.$event_is_running=true;var g=this.$validate_and_serialize(d);if(g==null){this.$event_is_running=false;if(h){h()}return}var c=jQuery.extend({},a.$params,g,b,{eventContext:f});var j=jQuery.extend({dataType:"text",cache:false,success:null,error:null},i);this.$event_success_fun=j.success;this.$event_error_fun=j.error;if(this.$websockets_enabled){delete c.pageContext;var e=Bert.encode_to_bytearray(Bert.tuple(Bert.atom("nitrogen_postback"),c));this.$websocket.send(e.buffer)}else{jQuery.ajax({url:this.$url,type:"post",data:[jQuery.param(c),b||""].join("&"),dataType:j.dataType,cache:j.cache,success:function(k,l){a.$event_success(k,l)},error:function(k,m,l){a.$event_error(k,m,l)}})}};NitrogenClass.prototype.$event_success=function(data,textStatus){this.$event_is_running=false;if(typeof this.$event_success_fun=="function"){this.$event_success_fun(data,textStatus)}else{eval(data)}};NitrogenClass.prototype.$event_error=function(a,c,b){this.$event_is_running=false;if(typeof this.$event_error_fun=="function"){this.$event_error_fun(a,c,errThrown)}};NitrogenClass.prototype.$do_system_event=function(a){var d=this;d.$system_event_is_running=true;var b=jQuery.extend({},d.$params,{eventContext:a,is_system_event:1});if(this.$websockets_enabled){delete b.pageContext;var c=Bert.encode_to_bytearray(Bert.tuple(Bert.atom("nitrogen_postback"),b));d.$websocket.send(c.buffer)}else{d.$system_event_obj=$.ajax({url:this.$url,type:"post",data:jQuery.param(b),dataType:"text",cache:false,success:function(e,f){d.$system_event_success(e)},error:function(e,g,f){d.$system_event_error()}})}};NitrogenClass.prototype.$system_event_success=function(data){var n=this;n.$system_event_is_running=false;n.$system_event_obj=null;var pc=n.$params.pageContext;eval(data);n.$set_param("pageContext",pc)};NitrogenClass.prototype.$system_event_error=function(){this.$system_event_is_running=false;this.$system_event_obj=null};NitrogenClass.prototype.$send_pending_files=function(c,a){var b=null;if(typeof(c.$nitrogen_pending_files)=="object"){while(b=c.$nitrogen_pending_files.shift()){b.submit()}}};NitrogenClass.prototype.$recalculate_upload_dimensions=function(d){if(typeof d=="string"){d=objs(d)}var a=$(d).find(".upload-button");var b=$(a).outerWidth(true);var c=$(a).outerHeight(true);$(d).find(".upload-content:visible").width(b).height(c)};NitrogenClass.prototype.$attach_upload_handle_dragdrop=function(d,b,c){var a=this;if(typeof(c)=="undefined"){c={}}if(typeof(d.$nitrogen_pending_files)=="undefined"){d.$nitrogen_pending_files=[]}jQuery.getScript("/nitrogen/jquery.fileupload.min.js",function(){var e=jQuery(d).children(".upload_drop");jQuery(b).fileupload({dropZone:(c.droppable?e:null),singleFileUploads:true,sequentialUploads:true,url:a.$url,paramName:"file",formData:function(){d.elements.pageContext.value=a.$params.pageContext;var f=jQuery(d).serializeArray();return f},start:function(f){d.pageContext.value=a.$params.pageContext;jQuery(d).children(".upload_progress").fadeIn().text("Uploading...")},progressall:function(h,f){var g=parseInt(f.loaded/f.total*100,10);jQuery(d).children(".upload_progress").text(g+"% ("+f.loaded+"/"+f.total+" bytes)")},progress:function(g,f){},send:function(g,f){},stop:function(g,f){},always:function(g,f){},fail:function(h,g,f){Nitrogen.$increment_pending_upload_counter(d,-1)},add:function(g,f){jQuery.each(f.files,function(h,j){jQuery(d).children(".upload_droplist").prepend(jQuery("<li></li>").attr("filename",j.name).text(j.name));Nitrogen.$increment_pending_upload_counter(d,1)});if(c.autoupload){f.submit()}else{d.$nitrogen_pending_files.push(f)}},done:function(h,g){if(typeof g.result=="string"){var f=g.result}else{if(typeof g.result=="object"){var f=g.result[0].body.innerHTML}else{var f=""}}jQuery.globalEval(f);Nitrogen.$increment_pending_upload_counter(d,-1)}})})};NitrogenClass.prototype.$increment_pending_upload_counter=function(b,c){var a=$(b).data("pending_uploads");if(typeof(a)=="undefined"){a=0}a+=c;$(b).data("pending_uploads",a);if(a==0){jQuery(b).children(".upload_progress").fadeOut();Nitrogen.$alert_unfinished_files(b)}};NitrogenClass.prototype.$upload_finished=function(a){jQuery(".upload_droplist").children('li[filename="'+a+'"]').css("text-decoration","line-through").addClass("upload_successful").fadeOut()};NitrogenClass.prototype.$alert_unfinished_files=function(c){var b=$(c).find(".upload_droplist li:not(.upload_successful):visible");if(b.length>0){$(c).find(".upload_droplist li:not(.upload_successful)").css("color","red").fadeOut("slow");var a=$(b).get().map(function(d){return $(d).text()}).join("\r\n");alert("There was an error uploading the following file(s):\r\n"+a+"\r\n\r\nThis is likely due to the file(s) being too large or a misconfiguration on the server")}};function obj(b,a){return objs(b,a).get(0)}function objs(k,e){k=jQuery.trim(k);if(!e){e=Nitrogen.$anchor_path}else{e=Nitrogen.$path_alias(e)}if(k.indexOf(",")!=-1){var j=k.split(",");var f=$();for(var c=0;c<j.length;c++){f=f.add(objs(j[c],e))}return f}if(k=="page"||k==".page"){return jQuery(document)}k=k.replace(/##/g,".wfid_");k=k.replace(/\bme\b/g,e);if(k.indexOf(" ")==-1&&k.indexOf(".")==-1&&k.indexOf("#")==-1){var d=objs(".wfid_"+k,e);if(d.length>0){return d}if(d.length==0&&jQuery.inArray(k.toLowerCase(),Nitrogen.$valid_elements)==-1){return jQuery()}}var h=new RegExp(/^body\b/);if(h.test(k)){return jQuery(k)}var g=jQuery(Nitrogen.$anchor_root_path).find(e);var d=g.find(k);if(d.length>0){return d}var d=g.parentsUntil(Nitrogen.$anchor_root_path);for(var c=0;c<d.length;c++){var b=jQuery(d.get(c)).find(k);if(b.length>0){return b}}return jQuery(k)}NitrogenClass.prototype.$valid_elements=["a","abbr","acronym","address","applet","area","b","base","basefont","bdo","big","blockquote","body","br","button","caption","center","cite","code","col","colgroup","dd","del","dfn","dir","div","dl","dt","em","fieldset","font","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","hr","html","i","iframe","img","input","ins","isindex","kbd","label","legend","li","link","map","menu","meta","noframes","noscript","object","ol","optgroup","option","p","param","pre","q","s","samp","script","select","small","span","strike","strong","style","sub","sup","table","tbody","td","textarea","tfoot","th","thead","title","tr","tt","u","ul","var"];NitrogenClass.prototype.$observe_event=function(a,d,b,c){objs(d,a).bind(b,c)};NitrogenClass.prototype.$update=function(a,c,b){objs(c,a).html(b)};NitrogenClass.prototype.$replace=function(a,c,b){objs(c,a).replaceWith(b)};NitrogenClass.prototype.$insert_top=function(a,c,b){objs(c,a).prepend(b)};NitrogenClass.prototype.$insert_bottom=function(a,c,b){objs(c,a).append(b)};NitrogenClass.prototype.$insert_before=function(a,c,b){objs(c,a).before(b)};NitrogenClass.prototype.$insert_after=function(a,c,b){objs(c,a).after(b)};NitrogenClass.prototype.$remove=function(a,b){objs(b,a).remove()};NitrogenClass.prototype.$dependency_register_function=function(b,a){if(this.$is_dependency_loaded(b)){a()}else{this.$load_js_dependency(b);this.$js_dependencies[b].pending_calls.push(a)}};NitrogenClass.prototype.$load_js_dependency=function(a){if(!this.$is_dependency_initialized(a)){this.$init_dependency_if_needed(a);jQuery.getScript(a,function(){Nitrogen.$js_dependencies[a].loaded=true;Nitrogen.$execute_dependency_scripts(a)})}};NitrogenClass.prototype.$init_dependency_if_needed=function(a){if(this.$js_dependencies[a]===undefined){this.$js_dependencies[a]={loaded:false,pending_calls:[]}}};NitrogenClass.prototype.$is_dependency_initialized=function(a){return this.$js_dependencies[a]!==undefined};NitrogenClass.prototype.$is_dependency_loaded=function(a){if(!this.$is_dependency_initialized(a)){return false}else{return this.$js_dependencies[a].loaded}};NitrogenClass.prototype.$execute_dependency_scripts=function(b){var a;while(a=this.$js_dependencies[b].pending_calls.shift()){a()}};NitrogenClass.prototype.$console_log=function(b){try{console.log(b)}catch(a){}};NitrogenClass.prototype.$return_false=function(b,a){return false};NitrogenClass.prototype.$is_key_code=function(b,c,a){return(b&&b.keyCode==c&&b.shiftKey==a)};NitrogenClass.prototype.$go_next=function(a){var b=obj(a);if(b.focus){b.focus()}if(b.select){b.select()}};NitrogenClass.prototype.$disable_selection=function(a){a.onselectstart=function(){return false};a.unselectable="on";a.style.MozUserSelect="none";a.style.cursor="default"};NitrogenClass.prototype.$set_value=function(a,b,c){if(!b.id){b=objs(b)}b.each(function(d,e){if(e.value!=undefined){e.value=c}else{if(e.checked!=undefined){e.checked=c}else{if(e.src!=undefined){e.src=c}else{$(e).html(c)}}}})};NitrogenClass.prototype.$get_value=function(a,b){if(!b.id){b=objs(b)}el=b.get(0);if(el.value!=undefined){return el.value}else{if(el.checked!=undefined){return el.checked}else{if(el.src!=undefined){return el.src}else{return $(el).html()}}}};NitrogenClass.prototype.$normalize_param=function(a,c){var b="";if(a){b=a}if(a&&c){b=a+"="+c}return a+"&"+c};NitrogenClass.prototype.$encode_arguments_object=function(d){if(!Bert){alert("Bert.js library not included in template.")}var b=new Array();for(var c=0;c<d.length;c++){b.push(d[c])}var e=Bert.encode(b);return{args:e}};NitrogenClass.prototype.$urlencode=function(a){return escape(a).replace(/\+/g,"%2B").replace(/%20/g,"+").replace(/\*/g,"%2A").replace(/\//g,"%2F").replace(/@/g,"%40")};NitrogenClass.prototype.$datepicker=function(b,a){jQuery(b).datepicker(a)};NitrogenClass.prototype.$autocomplete=function(c,a,b,e){var d=this;jQuery.extend(a,{select:function(g,h){var f=(h.item)&&'{"id":"'+h.item.id+'","value":"'+h.item.value+'"}'||"";d.$queue_event(null,null,e,"select_item="+d.$urlencode(f))},source:function(g,f){d.$queue_event(null,null,b,"search_term="+g.term,{dataType:"json",success:function(h){f(h)}})}});jQuery(c).autocomplete(a)};NitrogenClass.prototype.$draggable=function(b,a,c){objs(b).each(function(d,e){e.$drag_tag=c;jQuery(e).draggable(a)})};NitrogenClass.prototype.$droppable=function(c,a,b){var d=this;a.drop=function(e,g){var f=g.draggable[0].$drag_tag;d.$queue_event(null,null,b,"drag_item="+f)};objs(c).each(function(e,f){jQuery(f).droppable(a)})};NitrogenClass.prototype.$sortitem=function(a,c){var b=obj(a);b.$sort_tag=c;b.$drag_tag=c};NitrogenClass.prototype.$sortblock=function(a,d,b){var c=this;d.update=function(){var g="";for(var f=0;f<this.childNodes.length;f++){var e=this.childNodes[f];if(g!=""){g+=","}if(e.$sort_tag){g+=e.$sort_tag}}c.$queue_event(null,null,b,"sort_items="+g)};objs(a).sortable(d)};NitrogenClass.prototype.$trap_tabs=function(a){$(a).keydown(function(d){if(d.keyCode==9){var g=this.selectionStart;var b=this.selectionEnd;var c=$(this);var f=c.val();c.val(f.substring(0,g)+"\t"+f.substring(b));this.selectionStart=this.selectionEnd=g+1;return false}})};NitrogenClass.prototype.$from_alien=function(a){var b=$("input#"+a).val();objs(a).val(b)};NitrogenClass.prototype.$enable_websockets=function(){this.$console_log("Websockets Enabled");this.$websockets_enabled=true};NitrogenClass.prototype.$disable_websockets=function(){this.$console_log("Websockets disabled or disconnected");this.$websockets_enabled=false};NitrogenClass.prototype.$ws_init=function(){try{Bert.assoc_array_key_encoding("binary");var a=this;var c=this.$ws_url(location.href);this.$websocket=new WebSocket(c);this.$websocket.binaryType="arraybuffer";this.$websocket.onopen=function(d){a.$ws_open()};this.$websocket.onclose=function(d){a.$ws_close()};this.$websocket.onmessage=function(d){a.$ws_message(d.data)};this.$websocket.onerror=function(d){a.$ws_close()}}catch(b){}};NitrogenClass.prototype.$ws_url=function(a){return a.replace(/^http/,"ws")};NitrogenClass.prototype.$ws_open=function(){this.$send_pagecontext()};NitrogenClass.prototype.$send_pagecontext=function(){var a=this.$params.pageContext;var b=Bert.encode_to_bytearray(Bert.tuple(Bert.atom("page_context"),Bert.binary(a)));this.$websocket.send(b)};NitrogenClass.prototype.$ws_close=function(){this.$disable_websockets()};NitrogenClass.prototype.$ws_message=function(b){var a=null;if(a=b.match(/^nitrogen_system_event:([\s\S]*)/)){this.$system_event_success(a[1])}else{if(a=b.match(/^nitrogen_event:([\s\S]*)/)){this.$event_success(a[1])}}};NitrogenClass.prototype.$attempt_websockets=function(){var a=this;$(document).ready(function(){if(typeof Bert=="object"){a.$ws_init()}else{a.$console_log("Bert not linked from template. Attempting to load dynamically.");a.$dependency_register_function("/nitrogen/bert.js",function(){a.$console_log("Bert successfully loaded");a.$ws_init()})}})};var Nitrogen=new NitrogenClass();var page=document;Nitrogen.$attempt_websockets();Nitrogen.$event_loop();